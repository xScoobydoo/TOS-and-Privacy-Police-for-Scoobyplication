<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Terms of Service — Discord Bot</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-4xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">Terms of Service — Discord Bot</h1>
      <p class="text-sm text-gray-600 mt-1">Seite zum Abrufen, Anzeigen und Akzeptieren der Nutzungsbedingungen (TOS) für deinen Discord-Bot.</p>
    </header>

    <main class="grid grid-cols-1 gap-6 md:grid-cols-3">
      <section class="md:col-span-2 bg-white rounded-lg shadow p-6">
        <div class="flex items-start justify-between">
          <h2 class="text-xl font-semibold">Aktuelle Nutzungsbedingungen</h2>
          <div class="text-sm text-gray-500">Stand: <span id="tos-date">—</span></div>
        </div>

        <div id="tos-content" class="mt-4 prose max-w-none text-sm text-gray-700 p-4 border rounded bg-gray-50 h-96 overflow-auto">
          <!-- TOS Text wird hier eingefügt -->
        </div>

        <div class="mt-4 flex space-x-2">
          <button id="refresh-tos" class="px-3 py-1 text-sm rounded bg-blue-600 text-white">TOS neu laden</button>
          <button id="download-tos" class="px-3 py-1 text-sm rounded border">TOS herunterladen</button>
          <button id="print-tos" class="px-3 py-1 text-sm rounded border">Drucken</button>
        </div>

        <hr class="my-4" />

        <div>
          <h3 class="font-medium">Akzeptieren der TOS</h3>
          <p class="text-sm text-gray-600">Setze ein Häkchen und bestätige, um die Nutzungsbedingungen anzunehmen. Die Annahme wird lokal registriert und (optional) an einen Webhook gesendet.</p>

          <label class="mt-3 flex items-start space-x-2">
            <input id="accept-checkbox" type="checkbox" class="mt-1" />
            <span class="text-sm">Ich habe die <strong>Nutzungsbedingungen</strong> gelesen und akzeptiere sie.</span>
          </label>

          <div class="mt-3 flex items-center space-x-2">
            <input id="webhook-url" type="url" placeholder="(optional) Webhook URL zur Speicherung, z. B. https://example.com/webhook" class="flex-1 border rounded px-3 py-2 text-sm" />
            <button id="accept-btn" class="px-4 py-2 bg-green-600 text-white rounded disabled:opacity-50" disabled>Akzeptieren</button>
          </div>

          <p id="accept-status" class="mt-3 text-sm text-gray-600"></p>
        </div>

      </section>

      <aside class="bg-white rounded-lg shadow p-6">
        <h3 class="font-semibold">Einstellungen / Entwickler</h3>
        <p class="text-sm text-gray-600">Hier kannst du die Quelle der TOS konfigurieren oder Akzeptanz-Belege herunterladen.</p>

        <div class="mt-4 space-y-3">
          <label class="block text-sm">TOS-Quelle (optional):</label>
          <input id="tos-url" type="url" placeholder="z. B. https://example.com/tos.json oder leer für eingebaut" class="w-full border rounded px-3 py-2 text-sm" />

          <label class="block text-sm">Version / Tag:</label>
          <input id="tos-version" type="text" placeholder="z. B. v1.2.3" class="w-full border rounded px-3 py-2 text-sm" />

          <div class="flex space-x-2">
            <button id="load-from-url" class="flex-1 px-3 py-2 rounded border text-sm">Laden</button>
            <button id="use-embedded" class="flex-1 px-3 py-2 rounded border text-sm">Eingebaute TOS nutzen</button>
          </div>

          <hr />

          <h4 class="font-medium">Akzeptanz-Historie</h4>
          <div id="history" class="mt-2 text-sm max-h-40 overflow-auto mono text-xs text-gray-700 border rounded p-2 bg-gray-50"></div>

          <div class="mt-2 flex space-x-2">
            <button id="download-receipts" class="px-3 py-1 rounded border text-sm">Receipts herunterladen</button>
            <button id="clear-history" class="px-3 py-1 rounded border text-sm">History löschen</button>
          </div>
        </div>
      </aside>
    </main>

    <footer class="mt-6 text-xs text-gray-500">
      Hinweis: Diese Seite speichert Annahmen lokal (localStorage). Wenn du willst, kann die Annahme an deinen Server/Webhook geschickt werden. Sammle keine unnötigen personenbezogenen Daten ohne Einwilligung.
    </footer>
  </div>

  <script>
    // --- Beispiel-TOS (Deutsch) ---
    const EMBEDDED_TOS = {
      "version": "v1.0.0",
      "date": new Date().toISOString().split('T')[0],
      "text": `Nutzungsbedingungen für den Discord-Bot\n\n1. Allgemeines\nDieser Bot wird wie besehen zur Verfügung gestellt. Der Bot-Entwickler übernimmt keine Gewähr für Verfügbarkeit, Richtigkeit oder Eignung für einen bestimmten Zweck.\n\n2. Nutzung und Verhalten\Du verpflichtest dich, den Bot nicht für rechtswidrige Handlungen zu verwenden, keine Inhalte zu verbreiten, die gegen Discords Richtlinien verstoßen, und keine Maßnahmen zur Umgehung von Sicherheitsmechanismen zu ergreifen.\n\n3. Haftung\Der Entwickler haftet nur bei Vorsatz oder grober Fahrlässigkeit. Soweit gesetzlich zulässig, ist die Haftung auf den vorhersehbaren, vertragstypischen Schaden begrenzt.\n\n4. Änderungen an den TOS\Der Entwickler kann diese Bedingungen anpassen. Nutzer werden über Änderungen informiert, und durch weitere Nutzung gelten die neuen Bedingungen als akzeptiert.\n\n5. Kontakt\Bei Fragen: kontakt@example.com\n\n(Ersetze diesen Beispieltext durch deine echten Bedingungen.)`
    };

    // --- Hilfsfunktionen ---
    function renderTOS(obj) {
      document.getElementById('tos-date').textContent = obj.version + ' • ' + obj.date;
      const el = document.getElementById('tos-content');
      el.textContent = obj.text;
    }

    function fetchTOS(url) {
      return fetch(url, { cache: 'no-store' }).then(resp => {
        if (!resp.ok) throw new Error('Fehler beim Laden: ' + resp.status);
        return resp.json();
      });
    }

    function saveAcceptance(receipt) {
      const key = 'bot-tos-acceptances';
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      arr.push(receipt);
      localStorage.setItem(key, JSON.stringify(arr));
      renderHistory();
    }

    function renderHistory() {
      const key = 'bot-tos-acceptances';
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      const el = document.getElementById('history');
      if (arr.length === 0) el.textContent = 'Keine Akzeptanzen gespeichert.';
      else el.textContent = arr.map(r => JSON.stringify(r)).reverse().join('\n\n');
    }

    function downloadObject(obj, filename) {
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // --- Initialisierung ---
    (function(){
      const tosContent = document.getElementById('tos-content');
      const acceptCheckbox = document.getElementById('accept-checkbox');
      const acceptBtn = document.getElementById('accept-btn');
      const acceptStatus = document.getElementById('accept-status');
      const webhookInput = document.getElementById('webhook-url');

      // default: embedded
      renderTOS(EMBEDDED_TOS);
      document.getElementById('tos-version').value = EMBEDDED_TOS.version;

      acceptCheckbox.addEventListener('change', () => {
        acceptBtn.disabled = !acceptCheckbox.checked;
      });

      document.getElementById('use-embedded').addEventListener('click', () => {
        renderTOS(EMBEDDED_TOS);
        document.getElementById('tos-url').value = '';
        acceptStatus.textContent = 'Eingebaute TOS geladen.';
      });

      document.getElementById('load-from-url').addEventListener('click', async () => {
        const url = document.getElementById('tos-url').value.trim();
        if (!url) { acceptStatus.textContent = 'Bitte eine URL eingeben.'; return; }
        acceptStatus.textContent = 'Lade...';
        try {
          const obj = await fetchTOS(url);
          // expect { version, date, text }
          if (!obj.text) throw new Error('Unerwartetes Format (erwarte JSON mit Feld "text").');
          renderTOS(obj);
          document.getElementById('tos-version').value = obj.version || '';
          acceptStatus.textContent = 'TOS erfolgreich geladen.';
        } catch (e) {
          acceptStatus.textContent = 'Fehler: ' + e.message;
        }
      });

      document.getElementById('refresh-tos').addEventListener('click', () => {
        const url = document.getElementById('tos-url').value.trim();
        if (url) document.getElementById('load-from-url').click();
        else { renderTOS(EMBEDDED_TOS); acceptStatus.textContent = 'Eingebaute TOS neu angezeigt.'; }
      });

      document.getElementById('download-tos').addEventListener('click', () => {
        const obj = { version: document.getElementById('tos-version').value || EMBEDDED_TOS.version, date: document.getElementById('tos-date').textContent, text: tosContent.textContent };
        downloadObject(obj, 'tos-' + (obj.version || 'v') + '.json');
      });

      document.getElementById('print-tos').addEventListener('click', () => { window.print(); });

      acceptBtn.addEventListener('click', async () => {
        const receipt = {
          id: Math.random().toString(36).slice(2,12),
          timestamp: new Date().toISOString(),
          tos_version: document.getElementById('tos-version').value || EMBEDDED_TOS.version,
          tos_date: document.getElementById('tos-date').textContent,
          accepted_via: 'web-accept-ui',
          user_agent: navigator.userAgent
        };

        // Save locally
        saveAcceptance(receipt);
        acceptStatus.textContent = 'Akzeptiert am ' + receipt.timestamp + '. Receipt lokal gespeichert.';

        // Optional: send to webhook
        const webhook = webhookInput.value.trim();
        if (webhook) {
          acceptStatus.textContent = acceptStatus.textContent + ' Sende an Webhook...';
          try {
            const resp = await fetch(webhook, {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ receipt })
            });
            if (!resp.ok) throw new Error('Webhook antwortete mit ' + resp.status);
            acceptStatus.textContent = acceptStatus.textContent + ' Webhook angenommen.';
          } catch (e) {
            acceptStatus.textContent = acceptStatus.textContent + ' Fehler beim Webhook: ' + e.message;
          }
        }
      });

      document.getElementById('download-receipts').addEventListener('click', () => {
        const arr = JSON.parse(localStorage.getItem('bot-tos-acceptances') || '[]');
        downloadObject(arr, 'tos-receipts.json');
      });

      document.getElementById('clear-history').addEventListener('click', () => {
        if (!confirm('History wirklich löschen? Dies entfernt alle lokal gespeicherten Akzeptanzen.')) return;
        localStorage.removeItem('bot-tos-acceptances');
        renderHistory();
      });

      // render history on load
      renderHistory();

    })();
  </script>
</body>
</html>
